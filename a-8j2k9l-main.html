<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ãµãŸã‚Šã®å®¶è¨ˆç°¿</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .nav-btn.active { color: #ec4899; }
        .nav-btn.active svg { transform: translateY(-2px); color: #ec4899; }
        ::-webkit-scrollbar { width: 0px; }
        body { -webkit-tap-highlight-color: transparent; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen pb-24 font-sans text-slate-900">

    <!-- Header -->
    <header class="bg-white/80 backdrop-blur-md sticky top-0 z-30 border-b border-slate-100 p-4">
        <div class="max-w-md mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2">
                <button onclick="changeMonth(-1)" class="p-2 hover:bg-slate-100 rounded-full transition-colors">
                    <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                </button>
                <span id="current-month-display" class="font-black text-slate-700 text-sm w-24 text-center">èª­ã¿è¾¼ã¿ä¸­...</span>
                <button onclick="changeMonth(1)" class="p-2 hover:bg-slate-100 rounded-full transition-colors">
                    <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                </button>
            </div>
            <div id="user-display" class="px-3 py-1 bg-slate-200 text-slate-600 rounded-full text-[10px] font-bold">
                æœªãƒ­ã‚°ã‚¤ãƒ³
            </div>
        </div>
    </header>

    <main class="max-w-md mx-auto p-4 space-y-6">
        
        <!-- HOME: å…¥åŠ›ã¨å±¥æ­´ -->
        <div id="home-screen" class="space-y-6">
            <!-- ç²¾ç®—çŠ¶æ³ã‚µãƒãƒªãƒ¼ -->
            <div class="bg-white p-5 rounded-3xl shadow-sm border border-slate-100 flex items-center justify-between">
                <div id="settlement-summary" class="flex-1 text-center border-r border-slate-50">
                    <div class="text-[10px] text-slate-400 font-bold uppercase">ç¾åœ¨ã®ç²¾ç®—çŠ¶æ³</div>
                    <div id="settlement-balance" class="font-black text-slate-700">è¨ˆç®—ä¸­...</div>
                </div>
                <button onclick="switchTab('settlement')" class="flex-1 text-blue-500 text-[10px] font-bold flex flex-col items-center gap-1">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
                    ç«‹æ›¿è©³ç´°
                </button>
            </div>

            <!-- å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
            <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100">
                <form id="transaction-form" class="space-y-4">
                    <div class="flex p-1 bg-slate-100 rounded-xl">
                        <label class="flex-1 text-center cursor-pointer">
                            <input type="radio" name="type" value="expense" checked class="hidden peer" onchange="toggleType('expense')">
                            <div class="peer-checked:bg-white peer-checked:text-pink-600 peer-checked:shadow-sm rounded-lg py-2 text-xs font-black text-slate-500 transition-all">æ”¯å‡º</div>
                        </label>
                        <label class="flex-1 text-center cursor-pointer">
                            <input type="radio" name="type" value="income" class="hidden peer" onchange="toggleType('income')">
                            <div class="peer-checked:bg-white peer-checked:text-green-600 peer-checked:shadow-sm rounded-lg py-2 text-xs font-black text-slate-500 transition-all">æ­³å…¥</div>
                        </label>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <input type="date" id="date" required class="bg-slate-50 p-3 rounded-xl text-sm border-none outline-none focus:ring-2 ring-slate-200 transition-all">
                        <input type="number" id="amount" placeholder="é‡‘é¡" required class="bg-slate-50 p-3 rounded-xl text-sm border-none outline-none font-bold focus:ring-2 ring-slate-200 transition-all">
                    </div>
                    <input type="text" id="content" placeholder="å†…å®¹ï¼ˆä¾‹ï¼šãƒ©ãƒ³ãƒã€é›»æ°—ä»£ï¼‰" required class="w-full bg-slate-50 p-3 rounded-xl text-sm border-none outline-none focus:ring-2 ring-slate-200 transition-all">

                    <div id="expense-fields" class="grid grid-cols-2 gap-3">
                        <select id="cat-main" class="bg-slate-50 p-3 rounded-xl text-xs border-none outline-none"><option>ç”Ÿæ´»è²»</option><option>é£Ÿè²»</option><option>å®¶è³ƒãƒ»å…‰ç†±è²»</option><option>æ—¥ç”¨å“</option><option>è¶£å‘³ãƒ»å¨¯æ¥½</option><option>äº¤é€šè²»</option><option>ç‰¹åˆ¥ãªæ”¯å‡º</option><option>ãã®ä»–</option></select>
                        <select id="cat-sub" class="bg-slate-50 p-3 rounded-xl text-xs border-none outline-none"><option>å…±é€š</option><option>è‡ªåˆ†ç”¨</option><option>ç›¸æ‰‹ç”¨</option></select>
                    </div>
                    
                    <div id="income-fields" class="hidden">
                        <select id="cat-income" class="w-full bg-slate-50 p-3 rounded-xl text-xs border-none outline-none"><option>çµ¦æ–™</option><option>ãƒœãƒ¼ãƒŠã‚¹</option><option>å‰¯æ¥­</option><option>è‡¨æ™‚åå…¥</option></select>
                    </div>

                    <div id="reimbursement-section" class="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                        <label class="flex items-center gap-3 cursor-pointer">
                            <input type="checkbox" id="is-reimbursement" onchange="toggleReimbursementMode()" class="w-4 h-4 rounded border-slate-300 text-blue-500 focus:ring-blue-500">
                            <span class="text-xs font-bold text-slate-600">ç«‹æ›¿ã¨ã—ã¦è¨˜éŒ²ï¼ˆç²¾ç®—å¯¾è±¡ï¼‰</span>
                        </label>
                        <div id="reimbursement-details" class="hidden mt-3 space-y-3 animate-in slide-in-from-top duration-200">
                            <select id="reimbursement-mode" onchange="toggleCustomSplit(this.value)" class="w-full bg-white p-2 rounded-lg text-xs border border-slate-200 outline-none">
                                <option value="split">ãã£ã¡ã‚ŠåŠåˆ† (50:50)</option>
                                <option value="custom">è² æ‹…é¡ã‚’æŒ‡å®šã™ã‚‹</option>
                            </select>
                            <div id="split-detail" class="hidden grid grid-cols-2 gap-2">
                                <div><label class="text-[9px] text-slate-400 font-bold ml-1 uppercase">Aã®è² æ‹…</label><input type="number" id="amount-a" class="w-full bg-white p-2 rounded-lg text-xs border border-slate-200 outline-none"></div>
                                <div><label class="text-[9px] text-slate-400 font-bold ml-1 uppercase">Bã®è² æ‹…</label><input type="number" id="amount-b" class="w-full bg-white p-2 rounded-lg text-xs border border-slate-200 outline-none"></div>
                            </div>
                        </div>
                    </div>
                    <button type="submit" id="submit-btn" class="w-full bg-slate-800 text-white p-4 rounded-2xl font-black text-sm shadow-xl shadow-slate-200 active:scale-[0.98] transition-all disabled:bg-slate-300">
                        è¨˜éŒ²ã‚’ä¿å­˜ã™ã‚‹
                    </button>
                </form>
            </div>

            <!-- å±¥æ­´ãƒªã‚¹ãƒˆ -->
            <div class="bg-white rounded-3xl shadow-sm border border-slate-100 overflow-hidden">
                <div class="px-5 py-4 border-b border-slate-50 flex justify-between items-center">
                    <h3 class="font-black text-slate-700 text-sm">æœ€è¿‘ã®è¨˜éŒ²</h3>
                </div>
                <div id="record-list" class="divide-y divide-slate-50 max-h-[400px] overflow-y-auto">
                    <div class="p-10 text-center text-slate-400 text-xs">èª­ã¿è¾¼ã¿ä¸­...</div>
                </div>
            </div>
        </div>

        <!-- STATS: åˆ†æç”»é¢ -->
        <div id="stats-screen" class="hidden space-y-6">
            <div class="bg-white p-8 rounded-3xl shadow-sm border border-slate-100 text-center relative overflow-hidden">
                <div class="text-[10px] text-slate-400 font-bold uppercase tracking-widest mb-1">ä»Šæœˆã®ä¸–å¸¯æ”¯å‡ºåˆè¨ˆ</div>
                <div id="total-exp-display" class="text-4xl font-black text-slate-800 mb-2">Â¥0</div>
                <div class="flex justify-center gap-4 text-[10px] font-bold">
                    <span class="text-blue-500">Aè² æ‹…: <span id="a-share-display">Â¥0</span></span>
                    <span class="text-pink-500">Bè² æ‹…: <span id="b-share-display">Â¥0</span></span>
                </div>
            </div>
            <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100">
                <h3 class="font-black text-slate-700 text-sm mb-6">ã‚«ãƒ†ã‚´ãƒªãƒ¼åˆ¥æ”¯å‡º</h3>
                <div class="flex justify-center mb-8 h-48"><canvas id="myChart"></canvas></div>
                <div id="category-stats-list" class="space-y-4"></div>
            </div>
        </div>

        <!-- SETTLEMENT: ç«‹æ›¿ç”»é¢ -->
        <div id="settlement-screen" class="hidden space-y-4">
            <div class="bg-slate-800 text-white p-6 rounded-3xl shadow-lg shadow-slate-200 text-center">
                <div class="text-[10px] text-slate-400 font-bold uppercase mb-1">ç¾åœ¨ã®æœªç²¾ç®—åˆè¨ˆ</div>
                <div id="settlement-large-display" class="text-3xl font-black">Â¥0</div>
                <div id="settlement-direction-display" class="text-xs mt-2 text-slate-300">æ¸…ç®—ã®å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“</div>
            </div>
            <h3 class="font-black text-slate-700 text-xs px-2 mt-6 uppercase tracking-wider">ç«‹æ›¿å±¥æ­´ï¼ˆç›´è¿‘20ä»¶ï¼‰</h3>
            <div id="reimbursement-list" class="space-y-3"></div>
        </div>
    </main>

    <!-- Navigation -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-lg border-t border-slate-100 p-3 z-40">
        <div class="max-w-md mx-auto flex justify-around items-center">
            <button onclick="switchTab('home')" id="nav-home" class="nav-btn active flex flex-col items-center gap-1 text-slate-400">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                <span class="text-[10px] font-bold">è¨˜éŒ²</span>
            </button>
            <button onclick="switchTab('stats')" id="nav-stats" class="nav-btn flex flex-col items-center gap-1 text-slate-400">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path><path d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"></path></svg>
                <span class="text-[10px] font-bold">åˆ†æ</span>
            </button>
            <button onclick="switchTab('settlement')" id="nav-settlement" class="nav-btn flex flex-col items-center gap-1 text-slate-400">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <span class="text-[10px] font-bold">ç«‹æ›¿</span>
            </button>
        </div>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, doc, deleteDoc, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- âš™ï¸ FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyCHXpyZApKA19bKbui4-pKNjVag7Y3A0ww",
            authDomain: "kakeibo-2944a.firebaseapp.com",
            projectId: "kakeibo-2944a",
            storageBucket: "kakeibo-2944a.firebasestorage.app",
            messagingSenderId: "628237748010",
            appId: "1:628237748010:web:23cbe6250a1a2f5ba04053"
        };
        const APP_ID_PATH = "futarino-kakeibo-v1";
        // --------------------------------------------

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- ğŸ” ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ã‚’ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰å–å¾— ---
        // ä¾‹: b-3n7v5x-sub.html ãªã‚‰ ãƒ¦ãƒ¼ã‚¶ãƒ¼B
        const fileName = window.location.pathname;
        let currentUserType = 'A'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯A
        if (fileName.includes('b-3n7v5x-sub')) {
            currentUserType = 'B';
        }
        // -----------------------------------------------

        let records = [];
        let chart = null;
        let selectedMonth = new Date().toISOString().slice(0, 7);
        let user = null;

        const $ = (id) => document.getElementById(id);

        window.switchTab = (tab) => {
            ['home', 'stats', 'settlement'].forEach(t => {
                $(`${t}-screen`).classList.add('hidden');
                $(`nav-${t}`).classList.remove('active', 'text-pink-500');
                $(`nav-${t}`).classList.add('text-slate-400');
            });
            $(`${tab}-screen`).classList.remove('hidden');
            $(`nav-${tab}`).classList.add('active', 'text-pink-500');
            $(`nav-${tab}`).classList.remove('text-slate-400');
            renderAll();
        };

        window.changeMonth = (val) => {
            const date = new Date(selectedMonth + "-01");
            date.setMonth(date.getMonth() + val);
            selectedMonth = date.toISOString().slice(0, 7);
            $('current-month-display').innerText = selectedMonth.replace('-', 'å¹´ ') + 'æœˆ';
            renderAll();
        };

        window.toggleType = (type) => {
            $('expense-fields').classList.toggle('hidden', type !== 'expense');
            $('income-fields').classList.toggle('hidden', type !== 'income');
            $('reimbursement-section').classList.toggle('hidden', type !== 'expense');
            if(type === 'income') {
                $('is-reimbursement').checked = false;
                toggleReimbursementMode();
            }
        };

        window.toggleReimbursementMode = () => {
            $('reimbursement-details').classList.toggle('hidden', !$('is-reimbursement').checked);
        };

        window.toggleCustomSplit = (val) => {
            $('split-detail').classList.toggle('hidden', val !== 'custom');
        };

        const init = async () => {
            try {
                await signInAnonymously(auth);
            } catch (e) {
                console.error("Auth failed", e);
            }
        };

        onAuthStateChanged(auth, (u) => {
            user = u;
            if (user) {
                $('user-display').innerText = `ãƒ­ã‚°ã‚¤ãƒ³ä¸­: ãƒ¦ãƒ¼ã‚¶ãƒ¼${currentUserType}`;
                $('user-display').classList.replace('bg-slate-200', currentUserType === 'A' ? 'bg-blue-500' : 'bg-pink-500');
                $('user-display').classList.add('text-white');
                
                const q = query(collection(db, 'artifacts', APP_ID_PATH, 'public', 'data', 'transactions'));
                onSnapshot(q, (snapshot) => {
                    records = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderAll();
                });
            }
        });

        $('transaction-form').onsubmit = async (e) => {
            e.preventDefault();
            if (!user) return;

            const btn = $('submit-btn');
            btn.disabled = true;
            btn.innerText = "ä¿å­˜ä¸­...";

            const type = document.querySelector('input[name="type"]:checked').value;
            const amount = parseInt($('amount').value);
            const isReimbursement = $('is-reimbursement').checked;

            const data = {
                user: currentUserType,
                date: $('date').value,
                type: type,
                amount: amount,
                content: $('content').value,
                categoryMain: type === 'expense' ? $('cat-main').value : $('cat-income').value,
                categorySub: type === 'expense' ? $('cat-sub').value : '',
                isReimbursement: isReimbursement,
                timestamp: Timestamp.now()
            };

            if (isReimbursement) {
                const mode = $('reimbursement-mode').value;
                data.amountA = mode === 'split' ? amount / 2 : (parseInt($('amount-a').value) || 0);
                data.amountB = mode === 'split' ? amount / 2 : (parseInt($('amount-b').value) || 0);
            }

            try {
                await addDoc(collection(db, 'artifacts', APP_ID_PATH, 'public', 'data', 'transactions'), data);
                $('transaction-form').reset();
                $('date').value = new Date().toISOString().slice(0, 10);
                toggleType('expense');
                toggleReimbursementMode();
            } catch (e) {
                alert("ã‚¨ãƒ©ãƒ¼: " + e.message);
            } finally {
                btn.disabled = false;
                btn.innerText = "è¨˜éŒ²ã‚’ä¿å­˜ã™ã‚‹";
            }
        };

        window.deleteRecord = async (id) => {
            if (confirm('ã“ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                await deleteDoc(doc(db, 'artifacts', APP_ID_PATH, 'public', 'data', 'transactions', id));
            }
        };

        function renderAll() {
            records.sort((a, b) => b.date.localeCompare(a.date));
            const monthRecords = records.filter(r => r.date.startsWith(selectedMonth));
            
            let netBalance = 0;
            records.filter(r => r.isReimbursement).forEach(r => {
                if (r.user === 'A') netBalance += (r.amountB || 0);
                else netBalance -= (r.amountA || 0);
            });

            updateSettlementUI(netBalance);
            updateHistoryUI(monthRecords);
            updateStatsUI(monthRecords);
        }

        function updateSettlementUI(balance) {
            const display = $('settlement-balance');
            const largeDisplay = $('settlement-large-display');
            const dirDisplay = $('settlement-direction-display');

            const abs = Math.abs(balance).toLocaleString();
            if (balance > 0) {
                display.innerHTML = `<span class="text-blue-600">B â†’ A: Â¥${abs}</span>`;
                largeDisplay.innerText = `Â¥${abs}`;
                dirDisplay.innerText = "BãŒAã«æ”¯æ‰•ã†ã¹ãæ®‹é«˜";
            } else if (balance < 0) {
                display.innerHTML = `<span class="text-pink-600">A â†’ B: Â¥${abs}</span>`;
                largeDisplay.innerText = `Â¥${abs}`;
                dirDisplay.innerText = "AãŒBã«æ”¯æ‰•ã†ã¹ãæ®‹é«˜";
            } else {
                display.innerText = "æ¸…ç®—ãªã—";
                largeDisplay.innerText = "Â¥0";
                dirDisplay.innerText = "è²¸ã—å€Ÿã‚Šã¯ç¾åœ¨ã‚ã‚Šã¾ã›ã‚“";
            }

            $('reimbursement-list').innerHTML = records.filter(r => r.isReimbursement).slice(0, 20).map(r => `
                <div class="p-4 bg-white rounded-2xl shadow-sm flex justify-between items-center border-l-4 ${r.user === 'A' ? 'border-blue-400' : 'border-pink-400'}">
                    <div class="text-[10px]">
                        <div class="text-slate-400 mb-1">${r.date}</div>
                        <div class="font-bold text-slate-700 text-xs">${r.content}</div>
                        <div class="text-slate-400">æ”¯æ‰•:${r.user} | Aè² æ‹…:${Math.round(r.amountA)} Bè² æ‹…:${Math.round(r.amountB)}</div>
                    </div>
                    <div class="text-sm font-black">Â¥${r.amount.toLocaleString()}</div>
                </div>
            `).join('');
        }

        function updateHistoryUI(data) {
            $('record-list').innerHTML = data.length ? data.map(r => `
                <div class="flex justify-between items-center p-4 bg-white transition-colors active:bg-slate-50">
                    <div>
                        <div class="text-[9px] text-slate-400 flex items-center gap-1 uppercase font-bold">
                            <span class="${r.user === 'A' ? 'text-blue-500' : 'text-pink-500'}">${r.user}</span>
                            <span>â€¢</span>
                            <span>${r.date}</span>
                            ${r.isReimbursement ? '<span class="bg-blue-50 text-blue-500 px-1 rounded-[4px] text-[8px]">ç«‹æ›¿</span>' : ''}
                        </div>
                        <div class="text-sm font-bold text-slate-700">${r.content}</div>
                        <div class="text-[10px] text-slate-400">${r.categoryMain}</div>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="text-right">
                            <div class="text-sm font-black ${r.type === 'expense' ? 'text-red-500' : 'text-green-500'}">
                                ${r.type === 'expense' ? '-' : '+'}Â¥${r.amount.toLocaleString()}
                            </div>
                        </div>
                        <button onclick="deleteRecord('${r.id}')" class="text-slate-200 hover:text-red-500 p-1">Ã—</button>
                    </div>
                </div>
            `).join('') : '<div class="p-10 text-center text-slate-400 text-xs font-bold tracking-widest uppercase">ãƒ‡ãƒ¼ã‚¿ãªã—</div>';
        }

        function updateStatsUI(monthRecords) {
            const expenses = monthRecords.filter(r => r.type === 'expense');
            const total = expenses.reduce((sum, r) => sum + r.amount, 0);
            const aShare = expenses.reduce((sum, r) => sum + (r.isReimbursement ? (r.amountA || 0) : (r.user === 'A' ? r.amount : 0)), 0);
            const bShare = expenses.reduce((sum, r) => sum + (r.isReimbursement ? (r.amountB || 0) : (r.user === 'B' ? r.amount : 0)), 0);

            $('total-exp-display').innerText = `Â¥${total.toLocaleString()}`;
            $('a-share-display').innerText = `Â¥${aShare.toLocaleString()}`;
            $('b-share-display').innerText = `Â¥${bShare.toLocaleString()}`;

            const catMap = {};
            expenses.forEach(r => {
                catMap[r.categoryMain] = (catMap[r.categoryMain] || 0) + r.amount;
            });

            const sorted = Object.entries(catMap).sort((a, b) => b[1] - a[1]);
            $('category-stats-list').innerHTML = sorted.map(([name, val]) => {
                const perc = Math.round(val / (total || 1) * 100);
                return `
                    <div class="text-[10px]">
                        <div class="flex justify-between mb-1 font-bold">
                            <span class="text-slate-600">${name}</span>
                            <span class="text-slate-400">Â¥${val.toLocaleString()} (${perc}%)</span>
                        </div>
                        <div class="w-full bg-slate-100 h-1.5 rounded-full overflow-hidden">
                            <div class="bg-slate-800 h-full transition-all duration-500" style="width:${perc}%"></div>
                        </div>
                    </div>
                `;
            }).join('');

            const ctx = $('myChart').getContext('2d');
            if (chart) chart.destroy();
            chart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: sorted.map(s => s[0]),
                    datasets: [{
                        data: sorted.map(s => s[1]),
                        backgroundColor: ['#1e293b', '#334155', '#475569', '#64748b', '#94a3b8', '#cbd5e1', '#e2e8f0', '#f1f5f9']
                    }]
                },
                options: {
                    plugins: { legend: { display: false } },
                    cutout: '80%',
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        window.onload = () => {
            $('date').value = new Date().toISOString().slice(0, 10);
            $('current-month-display').innerText = selectedMonth.replace('-', 'å¹´ ') + 'æœˆ';
            init();
        };
        window.deleteRecord = deleteRecord;
    </script>
</body>
</html>
