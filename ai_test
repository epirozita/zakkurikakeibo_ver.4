import React, { useState, useEffect, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, onAuthStateChanged, signInAnonymously } from 'firebase/auth';
import { getFirestore, collection, addDoc, query, onSnapshot, doc, deleteDoc } from 'firebase/firestore';
import { FileText, Upload, Loader2, Plus, Trash2, PieChart, JapaneseYen, Clock, ShieldCheck } from 'lucide-react';

// --- Configuration & Constants ---
const apiKey = ""; // API Key provided by environment
const firebaseConfig = JSON.parse(window.__firebase_config || '{}');
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'salary-analyzer-demo';

const App = () => {
  const [user, setUser] = useState(null);
  const [records, setRecords] = useState([]);
  const [isAnalyzing, setIsAnalyzing] = useState(false);
  const [previewImage, setPreviewImage] = useState(null);
  const [analysisResult, setAnalysisResult] = useState(null);
  const fileInputRef = useRef(null);

  // 1. Auth Logic
  useEffect(() => {
    const initAuth = async () => {
      try {
        await signInAnonymously(auth);
      } catch (err) {
        console.error("Auth error:", err);
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, setUser);
    return () => unsubscribe();
  }, []);

  // 2. Fetch Data from Firestore
  useEffect(() => {
    if (!user) return;
    const q = collection(db, 'artifacts', appId, 'users', user.uid, 'salary_records');
    const unsubscribe = onSnapshot(q, (snapshot) => {
      const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      // Sort by date manually as per Rule 2
      data.sort((a, b) => new Date(b.date) - new Date(a.date));
      setRecords(data);
    }, (err) => console.error("Firestore error:", err));
    return () => unsubscribe();
  }, [user]);

  // 3. AI Analysis (Gemini API)
  const analyzeImage = async (base64Data) => {
    setIsAnalyzing(true);
    const systemPrompt = `
      You are an expert accountant. Analyze the provided image of a Japanese salary slip (給与明細).
      Extract the following information in JSON format:
      - companyName: string
      - payDate: string (YYYY-MM-DD)
      - totalSalary: number (支給額合計)
      - baseSalary: number (基本給)
      - overtimePay: number (残業手当)
      - totalDeductions: number (控除額合計)
      - netPay: number (差引支給額/手取り)
      - healthInsurance: number (健康保険)
      - incomeTax: number (所得税)
      
      If you cannot find a value, return 0. Only return valid JSON.
    `;

    try {
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{
            parts: [
              { text: "Analyze this salary slip and output JSON." },
              { inlineData: { mimeType: "image/png", data: base64Data.split(',')[1] } }
            ]
          }],
          systemInstruction: { parts: [{ text: systemPrompt }] },
          generationConfig: { responseMimeType: "application/json" }
        })
      });

      const result = await response.json();
      const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
      if (text) {
        setAnalysisResult(JSON.parse(text));
      }
    } catch (err) {
      console.error("Analysis failed:", err);
    } finally {
      setIsAnalyzing(false);
    }
  };

  const handleFileUpload = (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (event) => {
      setPreviewImage(event.target.result);
      analyzeImage(event.target.result);
    };
    reader.readAsDataURL(file);
  };

  const saveRecord = async () => {
    if (!user || !analysisResult) return;
    try {
      await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'salary_records'), {
        ...analysisResult,
        date: analysisResult.payDate || new Date().toISOString().split('T')[0],
        createdAt: new Date().toISOString()
      });
      setAnalysisResult(null);
      setPreviewImage(null);
    } catch (err) {
      console.error("Save error:", err);
    }
  };

  return (
    <div className="min-h-screen bg-slate-50 text-slate-900 p-4 md:p-8 font-sans">
      <div className="max-w-5xl mx-auto">
        {/* Header */}
        <header className="flex items-center justify-between mb-8">
          <div>
            <h1 className="text-2xl font-bold flex items-center gap-2">
              <JapaneseYen className="text-blue-600" />
              AI 給与明細スキャナー
            </h1>
            <p className="text-slate-500 text-sm">PDFや画像を読み込んで家計管理を自動化</p>
          </div>
          <div className="text-xs bg-white border p-2 rounded shadow-sm hidden md:block">
            UserID: <span className="font-mono text-blue-600">{user?.uid || 'Connecting...'}</span>
          </div>
        </header>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
          {/* Upload Section */}
          <div className="lg:col-span-1 space-y-6">
            <div 
              onClick={() => fileInputRef.current?.click()}
              className={`border-2 border-dashed rounded-2xl p-8 text-center cursor-pointer transition-all bg-white
                ${isAnalyzing ? 'border-blue-400 bg-blue-50' : 'border-slate-200 hover:border-blue-400 hover:shadow-md'}`}
            >
              <input 
                type="file" 
                ref={fileInputRef} 
                onChange={handleFileUpload} 
                className="hidden" 
                accept="image/*,application/pdf"
              />
              {isAnalyzing ? (
                <div className="flex flex-col items-center gap-3">
                  <Loader2 className="w-10 h-10 text-blue-500 animate-spin" />
                  <p className="font-medium">AIが解析中...</p>
                  <p className="text-xs text-slate-400">項目を抽出しています</p>
                </div>
              ) : (
                <div className="flex flex-col items-center gap-3">
                  <div className="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                    <Upload className="text-blue-600" />
                  </div>
                  <p className="font-medium">明細をアップロード</p>
                  <p className="text-xs text-slate-400">PNG, JPG, PDFに対応</p>
                </div>
              )}
            </div>

            {/* Analysis Result Confirmation */}
            {analysisResult && (
              <div className="bg-white border rounded-2xl p-6 shadow-sm space-y-4 animate-in fade-in slide-in-from-bottom-4">
                <h3 className="font-bold border-bottom pb-2 border-b">抽出結果の確認</h3>
                <div className="space-y-3">
                  <ResultItem label="支給日" value={analysisResult.payDate} />
                  <ResultItem label="総支給額" value={`¥${analysisResult.totalSalary?.toLocaleString()}`} highlight />
                  <ResultItem label="残業代" value={`¥${analysisResult.overtimePay?.toLocaleString()}`} />
                  <ResultItem label="社会保険料" value={`¥${analysisResult.healthInsurance?.toLocaleString()}`} />
                  <ResultItem label="手取り額" value={`¥${analysisResult.netPay?.toLocaleString()}`} highlight />
                </div>
                <button 
                  onClick={saveRecord}
                  className="w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 transition-colors flex items-center justify-center gap-2"
                >
                  <Plus size={18} /> データを保存する
                </button>
              </div>
            )}
          </div>

          {/* History / Dashboard */}
          <div className="lg:col-span-2 space-y-6">
            <div className="bg-white border rounded-2xl p-6 shadow-sm">
              <h3 className="font-bold mb-4 flex items-center gap-2 text-lg">
                <Clock className="text-slate-400" size={20} />
                履歴
              </h3>
              
              {records.length === 0 ? (
                <div className="py-20 text-center text-slate-400">
                  <FileText className="mx-auto mb-2 opacity-20" size={48} />
                  <p>まだデータがありません</p>
                </div>
              ) : (
                <div className="overflow-x-auto">
                  <table className="w-full text-left">
                    <thead>
                      <tr className="border-b text-slate-400 text-sm">
                        <th className="pb-3 font-medium">支給日</th>
                        <th className="pb-3 font-medium">総支給</th>
                        <th className="pb-3 font-medium">残業代</th>
                        <th className="pb-3 font-medium">手取り</th>
                        <th className="pb-3"></th>
                      </tr>
                    </thead>
                    <tbody>
                      {records.map((record) => (
                        <tr key={record.id} className="border-b last:border-0 hover:bg-slate-50 transition-colors group">
                          <td className="py-4 font-medium">{record.date}</td>
                          <td className="py-4">¥{record.totalSalary?.toLocaleString()}</td>
                          <td className="py-4 text-orange-600 font-medium">¥{record.overtimePay?.toLocaleString()}</td>
                          <td className="py-4 font-bold text-blue-600">¥{record.netPay?.toLocaleString()}</td>
                          <td className="py-4 text-right">
                            <button 
                              onClick={() => deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'salary_records', record.id))}
                              className="p-2 text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-all"
                            >
                              <Trash2 size={16} />
                            </button>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              )}
            </div>
            
            {/* Simple Insights */}
            {records.length > 0 && (
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="bg-gradient-to-br from-blue-500 to-blue-600 p-6 rounded-2xl text-white shadow-lg shadow-blue-200">
                  <ShieldCheck className="mb-2 opacity-80" />
                  <p className="text-blue-100 text-sm">平均手取り額</p>
                  <p className="text-3xl font-bold">
                    ¥{Math.round(records.reduce((acc, curr) => acc + curr.netPay, 0) / records.length).toLocaleString()}
                  </p>
                </div>
                <div className="bg-white border p-6 rounded-2xl shadow-sm">
                  <PieChart className="mb-2 text-blue-500" />
                  <p className="text-slate-500 text-sm">直近の残業比率</p>
                  <p className="text-3xl font-bold text-slate-800">
                    {Math.round((records[0]?.overtimePay / records[0]?.totalSalary) * 100)}%
                  </p>
                </div>
              </div>
            )}
          </div>
        </div>
      </div>
    </div>
  );
};

const ResultItem = ({ label, value, highlight }) => (
  <div className="flex justify-between items-center text-sm">
    <span className="text-slate-500">{label}</span>
    <span className={`font-mono ${highlight ? 'font-bold text-lg text-blue-600' : 'text-slate-700'}`}>{value}</span>
  </div>
);

export default App;
